# BOLD #1: Peer Protocol

Two willing parties may trade directly with each other by first establishing a secure TCP-based communication session between them.

The default TCP listening port is 8885 (XU in ASCII).

####Node Identity

All cryptographic operations are based on the secp256k1 elliptic curve. Each node is expected to maintain a persistent secp256k1 private key which is saved and restored between sessions. It is recommended that the private key can only be reset manually, for example, by deleting a file or database entry. 

####Initial Handshake

The communication session is established by creating a TCP connection and agreeing on ephemeral key material for further encrypted communication, in addition to utilizing the persistent key for authentication. The process of establishing this session is the “handshake” and is carried out between the “initiator” (the node which opened the TCP connection) and the “recipient” (the node which accepted it).

The handshake consists of *each side* sending the `SessionInit` message, and waiting to receive the `SessionAck` message back. The first `SessionInit` message is expected to be sent by the initiator node.

The initiator node should know about the recipient node identity in advance.

The recipient node knows about the initiator node identity only after receiving its `SessionAck` message.

By the end of the handshake, two distinct shared keys are created, one for each side of the communication, to be used for encrypting all messages during the session lifetime. 

####The SessionInit Message (0x00)

	1. string id
	Message's globally unique identifier, generated by the sender 
	
	2. string sign 
    secp256k1 signature over sha256 hash of a JSON-serialized msg containing fields 3-7

    3. string peer_pub_key
    The target node secp256k1 public key (in hex)

    4. string ephemeral_pub_key 
    An ephemeral secp256k1 public key (in hex), generated by the sender, for ECDH key exchange

    5. NodeState node_state
    General info regarding the sender current node state

    6. string version
    OpenDEX client version

    7. string node_pub_key
    The sender secp256k1 public key (in hex)

Once received by the destination node, the message origins can be authenticated as follows:

* `peer_pub_key` should match the destination node public key 
* `node_pub_key` should match the sender node expected public key (relevant for the initiator node only, which knows the recipient node identity in advance)
* `sign` should be a valid *secp256k1* signature over sha256 hash of a JSON-serialized msg containing fields 3-7

If valid, the destination node is expected to immediately send the `SessionAck` message back. If not received in reasonable time frame (usually 10 seconds), the sender node may disconnect.

####The SessionAck Message (0x01)

	1. string id
	Message's globally unique identifier, generated by the sender
	 
	2. string req_id
    Link to the id field from the received SessionInit message

    3. string ephemeral_pub_key
    An ephemeral secp256k1 public key (in hex), generated by the sender, for ECDH key exchange

Once the sender generated his ECDH keys, it can calculate the shared key by using `ephemeral_pub_key` field from the `SessionInit` message. 

Once the message is received by the destination node (the one which sent the `SessionInit` message), it can compute the shared key as well.

All future communication from the sender side to the receiver henceforth is expected to use that key to encrypt all data, using *aes-256-cbc* symmetric encryption scheme.

##Control Messages

####The Ping Message (0x04)

	1. string id 
	Message's globally unique identifier, generated by the sender 
	

In order to allow for the existence of long-lived TCP connections, at times it may be required that both ends keep alive the TCP connection at the application level. Such messages also allow obfuscation of traffic patterns.
	
The sender of the `Ping` message expected to receive the `Pong` message back within a limited time frame. Otherwise, it may disconnect.

####The Pong Message (0x05)

	1. string id
    Message's globally unique identifier, generated by the sender
     
	2. string req_id
    Link to the id field from the received Ping message

The `Pong` message is used to respond to the `Ping` message. It serves as a reply and also serves to keep the connection alive, while explicitly notifying the other end that the receiver is still active. 

####The Disconnecting Message (0x03)

    1. string id
    Message's globally unique identifier, generated by the sender 

	2. uint32 reason
    The reason for the imminent disconnection 

    3. string payload
	Optional payload to provide more info regarding the disconnection reason

The `Disconnecting` message is used to inform the connected peer that a disconnection is imminent; If received, the peer should disconnect immediately. When sending, well-behaved hosts give their peers a chance (wait 2 seconds) to disconnect before disconnecting themselves.

`reason` is an optional param specifying one of a number of reasons for the disconnection:

| Reason | Meaning                                       |
|--------|-----------------------------------------------|
| `0x01` | Response stalling                             |
| `0x02` | Incompatible client protocol version          |
| `0x03` | Unexpected identity                           |
| `0x04` | Forbidden identity update                     |
| `0x05` | Connected to self                             |
| `0x06` | Not accepting new connections                 |
| `0x07` | Banned                                        |
| `0x08` | Already connected                             |
| `0x09` | Shutdown                                      |
| `0x0a` | Malformed version                             |
| `0x0b` | Authentication failure: invalid target node   | 
| `0x0c` | Authentication failure: invalid signature     |
| `0x0d` | Wire protocol error                           |

####The GetNodes Message (0x0a)

	1. string id 
	Message's globally unique identifier, generated by the sender 
	
The `GetNodes` message is used to query a peer for his list of known OpenDEX-compliant reachable nodes from the current network. 

####The Nodes Message (0x0b)

	1. string id 
	Message's globally unique identifier, generated by the sender 
	
	2. string req_id
    Link to the id field from the received GetNodes message
    
    3. repeated Node nodes
    The list of known nodes

The `Nodes` message is used to respond to the `GetNodes` message.

####The NodeStateUpdate Message (0x02)

	1. string id 
	Message's globally unique identifier, generated by the sender 
	
	5. NodeState node_state
	The updated node state.

The `NodeStateUpdate` message is used to tell a peer about an update in the node state. An example for such update can be the removal of a supported trading pair, listening address, etc. 
	
###Messages fields custom types

####The NodeState type

    3. repeated Address addresses
    The sender listening TCP addresses for incoming connections

    4. repeated string pairs
    The sender list of trading pair symbols, constructed with the base currency first, followed by a  '/' separator and the quote currency (e.g., [“LTC/BTC”, “DAI/BTC”])

    5. string raiden_address
    The sender raiden address

    6. map<string, string> lnd_pub_keys
    The sender list of LND public keys

    7. map<string, string> token_identifiers
    Mapping between currency symbols to token identifiers such as lnd chains or raiden token contract address (e.g., { BTC: 'bitcoin-testnet', LTC: 'litecoin-testnet' })

    8. map<string, LndUris> lnd_uris 
    Mapping between currency symbols to LND listening uris (e.g., { BTC: ['localhost:30000'], LTC: '['localhost:30030', 'localhost:30031']' })

####The Address type

    1. string host 

    2. uint32 port

####The LndUris type 

    1. repeated string lnd_uri

####The Node type 

    1. string node_pub_key
    The node public key which its identity should be verified upon
    
    2. repeated Address addresses
    The node listening TCP addresses for incoming connections
