# BOLD #4: Swap Protocol

Once an order match is found on the taker order book, the following swap procedure is expected instantiate. The following is the protocol happy flow: 

1. Taker finds a match
2. Taker creates the private `r_preimage` and the public `r_hash` for the atomic swap
3. Taker sends the `SwapRequest` message to the maker, which includes `r_hash`
4. Maker confirms full or partial quantity in the `SwapAccepted` message
5. Taker starts the swap by dispatching the first-leg HTLCs on the quote currency chain to the maker end, using `r_hash`
6. Maker is listening for an incoming HTLC on the quote currency chain. Once arrived, he verifies price/quantity, and dispatches the second-leg HTLCs on the base currency chain to the taker end.
7. Taker is listening for an incoming HTLC on the base currency chain. Once arrived, he releases `r_preimage`. This allow **both** the taker and the maker payment to finalize.
9. Taker sends the `SwapCompleted` message to the maker

Possible misbehaviours and their outcome:

| Misbehaviour                                                                        | Outcome                                               | Effect on payment channels 
|-------------------------------------------------------------------------------------|-------------------------------------------------------|------------------------------------------------------------|
| Maker doesn't respond to the `SwapRequest` message                                  | Taker should timeout the swap and penalize the maker  | None                                                       |
| Taker doesn't start the swap after receiving the `SwapAccepted` message             | Maker should timeout the swap and penalize the taker  | None                                                       |
| Maker receives the first-leg HTLC with insufficient amount or incorrect CLTV delta  | Maker should send the taker the `SwapError` message   | Taker funds are locked until HTLC expiration               |
| Maker doesn't continue the swap after receiving the first-leg HTLC                  | Taker should timeout the swap and penalize the maker  | Taker funds are locked until HTLC expiration               |
| Taker receives the second-leg HTLC with insufficient amount or incorrect CLTV delta | Taker should sends the maker the `SwapError` message  | Both Taker and Maker funds are locked until HTLC expiration|
| Taker doesn't release `r_preimage` after receiving the second-leg HTLC              | Maker should timeout the swap and penalize the taker  | Both Taker and Maker funds are locked until HTLC expiration|
| Taker doesn't send the `SwapCompleted` message after releasing `r_preimage`         | None; swap has already finalized                      | None                                                       |

### The SwapRequest Message (0x0c)

	1. string id
	Message's globally unique identifier, generated by the sender 

    2. uint64 proposed_quantity
    The proposed quantity

    3. string pair_id
    The trading pair for the swap

    4. string order_id
    The unique identifier of the maker order

	5. string r_hash
	The taker preimage hash (in hex)

	6. uint32 taker_cltv_delta
    The CLTV delta from the current height that should be used to set the timelock for the final hop when sending to taker

The `SwapRequest` message is sent by the taker to the maker to start the swap negotiation. 

###The SwapAccepted Message (0x0d)

    1. string id
	Message's globally unique identifier, generated by the sender 
	
    2. uint64 req_id
    Link to the id field from the received SwapRequest message

	3. string r_hash
    The taker preimage hash (in hex) from the received SwapRequest message

	4. string quantity
	The accepted quantity (which may be less than the proposed quantity)

	5. uint32 maker_cltv_delta
    The CLTV delta from the current height that should be used to set the timelock for the final hop when sending to maker

The `SwapAccepted` message is sent by the maker to the taker to accept the swap request.

###The SwapComplete Message (0x0e)

	1. string id
	Message's globally unique identifier, generated by the sender 

	2. string r_hash
    The taker preimage hash (in hex)

The `SwapComplete` message is sent by the taker to the maker to announce the swap successful completion. 

###The SwapFailed Message (0x0f)

	1. string id
	Message's globally unique identifier, generated by the sender 

    2. uint64 req_id
    An optional link to the id field from the received SwapRequest message. Otherwise, this field should be empty

	3. string r_hash
	The taker preimage hash (in hex)

	4. string error_message
	Additional information regarding the failure reason

	5. uint32 failure_reason
	The failure reason

The `SwapFailed` message can be sent by either side of the swap protocol, at any time, to announce the swap termination.

`failure_reason` is an optional param for specifying the failure reason:

| Failure Reason | Meaning                       | Description                                                                                              |
|----------------|-------------------------------|----------------------------------------------------------------------------------------------------------|
| `0x00`         | Order Not Found               | Could not find the order specified by a swap request                                                     |
| `0x01`         | Order On Hold                 | The order specified by a swap request is on hold for a different ongoing swap                            |
| `0x02`         | Invalid Swap Request          | The swap request contained invalid data                                                                  |
| `0x03`         | Swap Client Not Setup         | We are not connected to both swap clients, or we are missing public key identifiers for the peer's nodes |
| `0x04`         | No Route Found                | Could not find a route to complete the swap                                                              |
| `0x05`         | Unexpected Client Error       | A swap client call failed for an unexpected reason                                                       |
| `0x06`         | Invalid Swap Message Received | Received a swap message with invalid data                                                                |
| `0x07`         | Send Payment Failure          | The call to send payment failed                                                                          |
| `0x08`         | Invalid Resolve Request       | The swap resolver request was invalid                                                                    |
| `0x09`         | Payment Hash Reuse            | The swap request attempts to reuse a payment hash                                                        |
| `0x0a`         | Swap Timed Out                | The swap timed out while we were waiting for it to complete execution                                    |
| `0x0b`         | Deal Timed Out                | The deal timed out while we were waiting for the peer to respond to our swap request                     |                                         |
| `0x0c`         | Unknown Error                 | The swap failed due to an unrecognized error                                                             |

